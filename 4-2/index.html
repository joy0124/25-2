<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AJAX CRUD Demo (MockAPI + Modal)</title>

  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <style>
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background-color:#f8fafc;
    }
    main{
      max-width:900px;
      margin:40px auto;
      padding:0 16px;
    }
    h1{
      margin-bottom:4px;
    }
    #status{
      margin-top:8px;
    }
    .disabled{
      opacity:.6;
      pointer-events:none;
    }
  </style>
</head>
<body>
  <main>
    <header class="mb-3">
      <h1 class="fw-bold">학생 관리 – AJAX CRUD (MockAPI)</h1>
      <p class="text-muted small mb-0">
        이 페이지는 MockAPI의 <code>student</code> 리소스를 사용해
        <strong>목록 / 추가 / 수정 / 삭제</strong>를 테스트합니다.
      </p>
    </header>

    <!-- 버튼 영역: Bootstrap 버튼 + d-grid 로 정렬 -->
    <div class="d-grid gap-2 my-3">
      <button id="btnLoad"   class="btn btn-primary btn-lg">학생데이터 가져오기 (GET)</button>
      <button id="btnCreate" class="btn btn-outline-primary">학생데이터 추가 (모달)</button>
      <button id="btnUpdate" class="btn btn-outline-secondary">선택 항목 수정 (모달)</button>
      <button id="btnDelete" class="btn btn-danger">선택 항목 삭제 (DELETE)</button>
    </div>

    <div id="status" class="text-muted small mb-2"></div>

    <!-- Bootstrap 테이블 스타일 적용 -->
    <table id="tbl" class="table table-striped table-hover table-sm align-middle">
      <thead class="table-secondary">
        <tr>
          <th style="width:60px">id</th>
          <th>name</th>
          <th style="width:80px">age</th>
          <th>major</th>
          <th>email</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <!-- 학생 추가/수정용 Modal -->
    <div class="modal fade" id="studentModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="studentModalLabel">학생데이터 추가</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="studentForm">
              <!-- hidden: 현재 선택된 id (업데이트용) -->
              <input type="hidden" id="studentId" />

              <div class="mb-3">
                <label for="name" class="form-label">이름</label>
                <input id="name" class="form-control" placeholder="name" />
              </div>

              <div class="mb-3">
                <label for="age" class="form-label">나이</label>
                <input id="age" type="number" min="1" step="1" class="form-control" placeholder="age" />
              </div>

              <div class="mb-3">
                <label for="major" class="form-label">전공</label>
                <input id="major" class="form-control" placeholder="major" />
              </div>

              <div class="mb-3">
                <label for="email" class="form-label">이메일</label>
                <input id="email" class="form-control" placeholder="email" />
              </div>
            </form>
            <p class="text-muted small mb-0">
              ※ 모든 입력값을 채운 뒤 <strong>저장</strong> 버튼을 누르면 MockAPI로 전송됩니다.
            </p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
            <button type="button" class="btn btn-primary" id="btnSave">저장</button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Bootstrap JS (bundle: Popper 포함) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // ★ 여기에는 이미 잘 쓰고 있던 네 MockAPI URL을 넣으면 됨 ★
  // 예시: const API = "https://6916d613a7a34288a27e90bb.mockapi.io/student";
  const API = "https://6916d613a7a34288a27e90bb.mockapi.io/student";

  let selectedId = null;
  let isBusy = false;
  let studentModal = null;
  let modalMode = "create"; // "create" or "update"

  window.onload = () => {
    studentModal = new bootstrap.Modal(document.getElementById("studentModal"));

    byId("btnLoad").addEventListener("click", getStudents);

    // 추가 버튼: 모달을 'create' 모드로 열기
    byId("btnCreate").addEventListener("click", () => {
      modalMode = "create";
      selectedId = null;
      clearForm();
      byId("studentModalLabel").textContent = "학생데이터 추가";
      studentModal.show();
    });

    // 수정 버튼: 선택된 행이 있어야 하며, 모달을 'update' 모드로 열기
    byId("btnUpdate").addEventListener("click", () => {
      if (!selectedId) {
        return setStatus("수정할 행을 먼저 테이블에서 클릭해 선택하세요.");
      }
      modalMode = "update";
      byId("studentModalLabel").textContent = `학생데이터 수정 (#${selectedId})`;
      byId("studentId").value = selectedId;
      studentModal.show();
    });

    // 모달의 저장 버튼
    byId("btnSave").addEventListener("click", () => {
      if (modalMode === "create") {
        createWithNumericIdByPUT();
      } else if (modalMode === "update") {
        const id = selectedId || byId("studentId").value;
        if (!id) return setStatus("선택된 항목이 없습니다.");
        putStudent(id);
      }
    });

    // 삭제 버튼
    byId("btnDelete").addEventListener("click", () => {
      if (!selectedId) {
        return setStatus("삭제할 행을 먼저 선택하세요.");
      }
      if (confirm(`#${selectedId} 항목을 삭제할까요?`)) deleteStudent(selectedId);
    });

    // 처음 로딩 시 자동으로 GET 실행
    getStudents();
  };

  function byId(id){ return document.getElementById(id); }
  function setStatus(msg){ byId("status").textContent = msg; }
  function lockUI(lock){
    const btns = ["btnLoad","btnCreate","btnUpdate","btnDelete","btnSave"].map(byId);
    btns.forEach(b => b && b.classList.toggle("disabled", !!lock));
    isBusy = !!lock;
  }

  // GET
  function getStudents(){
    if(isBusy) return;
    lockUI(true);
    const xhr = new XMLHttpRequest();
    xhr.open("GET", API);
    xhr.onload = () => {
      lockUI(false);
      if(xhr.status === 200){
        const data = JSON.parse(xhr.response || "[]");
        const asNum = v => /^\d+$/.test(String(v)) ? Number(v) : Infinity;
        data.sort((a,b) => (asNum(a.id) - asNum(b.id)) || String(a.id).localeCompare(String(b.id)));
        renderTable(data);
        setStatus(`총 ${data.length}건 로드 완료.`);
      }else{
        setStatus(`GET 실패: ${xhr.status} ${xhr.statusText}`);
      }
    };
    xhr.onerror = () => { lockUI(false); setStatus("GET 실패: 네트워크 오류"); };
    xhr.send();
  }

  // CREATE (POST)
  function createWithNumericIdByPUT(){
    if(isBusy) return;
    const form = getFormData();
    if(!form) return;

    lockUI(true);
    const xhr = new XMLHttpRequest();
    xhr.open("POST", API);
    xhr.setRequestHeader("content-type", "application/json; charset=UTF-8");
    xhr.onload = () => {
      lockUI(false);
      if(xhr.status === 201 || xhr.status === 200){
        clearForm();
        if(studentModal) studentModal.hide();
        getStudents();
        setStatus("새 학생 추가 완료!");
      }else{
        setStatus(`생성 실패: ${xhr.status} ${xhr.statusText}`);
      }
    };
    xhr.onerror = () => { lockUI(false); setStatus("생성 실패: 네트워크 오류"); };
    xhr.send(JSON.stringify(form));
  }

  // UPDATE
  function putStudent(id){
    if(isBusy) return;
    const payload = getFormData();
    if(!payload) return;

    lockUI(true);
    const xhr = new XMLHttpRequest();
    xhr.open("PUT", `${API}/${id}`);
    xhr.setRequestHeader("content-type", "application/json; charset=UTF-8");
    xhr.onload = () => {
      lockUI(false);
      if(xhr.status === 200){
        clearForm();
        selectedId = null;
        if(studentModal) studentModal.hide();
        getStudents();
        setStatus("수정 완료!");
      }else{
        setStatus(`PUT 실패: ${xhr.status} ${xhr.statusText}`);
      }
    };
    xhr.onerror = () => { lockUI(false); setStatus("PUT 실패: 네트워크 오류"); };
    xhr.send(JSON.stringify(payload));
  }

  // DELETE
  function deleteStudent(id){
    if(isBusy) return;
    lockUI(true);
    const xhr = new XMLHttpRequest();
    xhr.open("DELETE", `${API}/${id}`);
    xhr.onload = () => {
      lockUI(false);
      if(xhr.status === 200){
        selectedId = null;
        clearForm();
        getStudents();
        setStatus("삭제 완료!");
      }else{
        setStatus(`DELETE 실패: ${xhr.status} ${xhr.statusText}`);
      }
    };
    xhr.onerror = () => { lockUI(false); setStatus("DELETE 실패: 네트워크 오류"); };
    xhr.send();
  }

  // 테이블 렌더링
  function renderTable(rows){
    const tbody = byId("tbody");
    tbody.innerHTML = "";
    rows.forEach(row => {
      const tr = document.createElement("tr");
      tr.innerHTML =
        `<td>${row.id}</td>`+
        `<td>${escapeHtml(row.name)}</td>`+
        `<td>${row.age}</td>`+
        `<td>${escapeHtml(row.major)}</td>`+
        `<td>${escapeHtml(row.email)}</td>`;
      tr.style.cursor = "pointer";
      tr.addEventListener("click", () => {
        selectedId = row.id;
        byId("name").value = row.name;
        byId("age").value = row.age;
        byId("major").value = row.major;
        byId("email").value = row.email;
        byId("studentId").value = row.id;
        setStatus(`#${row.id} 선택됨 – "선택 항목 수정" 버튼으로 모달을 열어 수정할 수 있습니다.`);
      });
      tbody.appendChild(tr);
    });
  }

  // 폼 데이터 읽기 + 검증
  function getFormData(){
    const name = byId("name").value.trim();
    const ageRaw = byId("age").value.trim();
    const age = Number(ageRaw);
    const major = byId("major").value.trim();
    const email = byId("email").value.trim();
    const emailOk = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);

    if(!name || !major || !email){
      setStatus("모든 입력칸을 채워주세요.");
      return null;
    }
    if(!Number.isInteger(age) || age < 1){
      setStatus("age는 1 이상의 정수여야 합니다.");
      return null;
    }
    if(!emailOk){
      setStatus("email 형식이 올바르지 않습니다.");
      return null;
    }
    return { name, age, major, email };
  }

  function clearForm(){
    byId("name").value = "";
    byId("age").value = "";
    byId("major").value = "";
    byId("email").value = "";
    byId("studentId").value = "";
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
    })[m]);
  }
</script>
</body>
</html>
